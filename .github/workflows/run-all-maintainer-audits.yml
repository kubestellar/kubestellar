name: Run All Maintainer Audits

on:
  workflow_dispatch:
  schedule:
    # Run every Monday at 12:00 PM Eastern (17:00 UTC)
    - cron: "0 17 * * 1"

permissions:
  actions: write
  contents: read

jobs:
  audit-all:
    runs-on: ubuntu-latest

    steps:
      - name: Run audits for all maintainers sequentially
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # List of all maintainers
          MAINTAINERS=(
            "btwshivam"
            "clubanderson"
            "dumb0002"
            "francostellari"
            "gaurab-khanal"
            "kproche"
            "kunal-511"
            "mavrick-1"
            "mikespreitzer"
            "naman9271"
            "nupurshivani"
            "oksaumya"
            "onkar717"
            "pdettori"
            "rupam-it"
            "rxinui"
            "sagar2366"
            "vedansh-5"
            "waltforme"
          )

          echo "üöÄ Starting sequential maintainer audits for ${#MAINTAINERS[@]} maintainers..."
          echo "Each audit will wait 3.5 minutes before starting the next one."
          echo ""

          for maintainer in "${MAINTAINERS[@]}"; do
            echo "üìß Triggering audit for: $maintainer"
            
            gh workflow run maintainer-metrics.lock.yml \
              --repo ${{ github.repository }} \
              --ref ${{ github.ref_name }} \
              --field maintainer="$maintainer"
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Successfully triggered audit for $maintainer"
            else
              echo "‚ùå Failed to trigger audit for $maintainer"
              exit 1
            fi
            
            # Don't sleep after the last maintainer
            if [ "$maintainer" != "${MAINTAINERS[-1]}" ]; then
              echo "‚è≥ Waiting 3.5 minutes before next audit..."
              sleep 210
              echo ""
            fi
          done

          echo ""
          echo "üéâ All maintainer audits have been triggered!"
