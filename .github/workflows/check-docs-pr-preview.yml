# This workflow checks that PRs modifying website docs include a preview link in the PR description.
# It enforces KubeStellar's documentation PR best practices.

name: Check Docs PR Preview Link

on:
  pull_request:
    types: [opened, edited, synchronize]
    paths:
      - 'docs/content/**'
      - 'docs/README.md'
      - 'docs/mkdocs.yml'
      - 'docs/overrides/**'
      - 'docs/scripts/**'
      - 'docs/requirements.txt'
      - 'docs/main.py'
      - 'SECURITY.md'
      - 'CODE_OF_CONDUCT.md'
      - 'GOVERNANCE.md'
      - 'ONBOARDING.md'

jobs:
  check-preview-link:
    if: false
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: Check for Preview Link in PR Description (bash)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.head_ref }}
        run: |
          set -e
          BODY=$(gh pr view "$PR_NUMBER" --json body -q '.body')
          DOC_BRANCH_REGEX='^doc-'
          OWNER=$(gh pr view "$PR_NUMBER" --json headRepositoryOwner -q '.headRepositoryOwner.login')
          REPO_NAME=$(gh pr view "$PR_NUMBER" --json headRepository -q '.headRepository.name')
          GITHUB_PAGES_URL="https://${OWNER}.github.io/${REPO_NAME}/${BRANCH}"
          GREEN=$'\033[0;32m'
          RED=$'\033[0;31m'
          YELLOW=$'\033[1;33m'
          NC=$'\033[0m' # No Color

          if ! PREVIEW_LINE=$(echo "$BODY" | grep -iE '^\s*Preview.*https?://') ; then
            echo "${RED}[ERROR] Docs PR: No preview link found. Please include a line starting with 'Preview' and a valid GitHub Pages URL for your changes.${NC}"
            echo "ðŸ‘‰ For instructions on how to create a preview, see:"
            echo "   https://github.com/kubestellar/kubestellar/blob/main/docs/content/contribution-guidelines/operations/document-management.md#rendering-and-previewing-modifications-to-the-website"
            echo "   The easier choice is https://github.com/kubestellar/kubestellar/blob/main/docs/content/contribution-guidelines/operations/document-management.md#automatically-render-the-website"
            echo "   That requires just two things: prepare the gh-pages branch in your fork, and naming your PR's branch doc-<something>"
            echo
            exit 1
          else
            if [[ "$PREVIEW_LINE" == *"$GITHUB_PAGES_URL"* ]]; then
              if [[ "$BRANCH" =~ $DOC_BRANCH_REGEX ]]; then
                echo "${GREEN}[OK] Docs PR: doc- branch and preview link format matches expected GitHub Pages URL.${NC}"
              else
                echo "${YELLOW}[WARN] Docs PR: Preview link format is good, but branch does not start with doc-. Consider renaming to enable automatic previews.${NC}"
              fi
            else
              echo "${YELLOW}[WARN] Docs PR: Preview link found, but it does not match the expected GitHub Pages URL."
              PREVIEW_URL=$(echo "$PREVIEW_LINE" | grep -oE 'https?://[^ ]*' || true)
              echo "Expected: ${GITHUB_PAGES_URL}"
              echo "Found:    ${PREVIEW_URL}${NC}"
            fi
          fi
          echo
