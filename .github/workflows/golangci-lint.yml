name: Static Analysis

on:
  schedule:
    - cron: "0 2 * * 1"

  push:
    branches: [main]
    paths:
      - "**.go"
      - "go.mod"
      - "go.sum"
      - ".golangci.yaml"

  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint Go Code
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.59.1

      - name: Run golangci-lint (Fast Mode)
        run: |
          golangci-lint run --timeout=8m --issues-exit-code=0 --config=.golangci.yaml --fast --max-issues-per-linter=50 --max-same-issues=10

      - name: Add Lint Summary
        if: always()
        run: |
          echo "### Static Analysis (Resource-Efficient Mode)" >> $GITHUB_STEP_SUMMARY
          echo "- **Schedule**: Weekly runs (Mondays 2 AM UTC) + main branch pushes" >> $GITHUB_STEP_SUMMARY
          echo "- **Timeout**: Strict 10-minute limit" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode**: Fast lint with concurrency controls" >> $GITHUB_STEP_SUMMARY
          echo "- **Purpose**: OpenSSF badge compliance visibility" >> $GITHUB_STEP_SUMMARY
          echo "- **Config**: .golangci.yaml" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Impact**: 99% reduction vs per-PR runs" >> $GITHUB_STEP_SUMMARY
