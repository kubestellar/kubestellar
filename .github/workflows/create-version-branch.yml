name: Create Version Branch

on:
  repository_dispatch:
    types: [create-version-branch]
  workflow_dispatch:
    inputs:
      project:
        description: 'Project (kubestellar, a2a, kubeflex, multi-plugin, kubectl-claude)'
        required: true
        type: choice
        options:
          - kubestellar
          - a2a
          - kubeflex
          - multi-plugin
          - kubectl-claude
      version:
        description: 'Version number (e.g., 0.30.0)'
        required: true
      source_repo:
        description: 'Source repo (e.g., kubestellar/kubestellar)'
        required: true
      source_branch:
        description: 'Source branch/tag (e.g., release-0.30.0 or v0.30.0)'
        required: true
      set_as_latest:
        description: 'Set as latest version'
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  create-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_SYNC_TOKEN }}

      - name: Set variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "project=${{ github.event.client_payload.project }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "source_repo=${{ github.event.client_payload.source_repo }}" >> $GITHUB_OUTPUT
            echo "source_branch=${{ github.event.client_payload.source_branch }}" >> $GITHUB_OUTPUT
            echo "set_latest=true" >> $GITHUB_OUTPUT
          else
            echo "project=${{ inputs.project }}" >> $GITHUB_OUTPUT
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "source_repo=${{ inputs.source_repo }}" >> $GITHUB_OUTPUT
            echo "source_branch=${{ inputs.source_branch }}" >> $GITHUB_OUTPUT
            echo "set_latest=${{ inputs.set_as_latest }}" >> $GITHUB_OUTPUT
          fi

      - name: Determine branch name
        id: branch
        run: |
          PROJECT="${{ steps.vars.outputs.project }}"
          VERSION="${{ steps.vars.outputs.version }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present

          case "$PROJECT" in
            kubestellar) BRANCH="docs/${VERSION}" ;;
            a2a) BRANCH="docs/a2a/${VERSION}" ;;
            kubeflex) BRANCH="docs/kubeflex/${VERSION}" ;;
            multi-plugin) BRANCH="docs/multi-plugin/${VERSION}" ;;
            kubectl-claude) BRANCH="docs/kubectl-claude/${VERSION}" ;;
            *) echo "Unknown project: $PROJECT"; exit 1 ;;
          esac
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Branch name: $BRANCH"

      - name: Check if branch exists
        id: check-branch
        run: |
          if git ls-remote --heads origin "${{ steps.branch.outputs.name }}" | grep -q "${{ steps.branch.outputs.name }}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Branch ${{ steps.branch.outputs.name }} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Clone source docs (non-kubestellar projects only)
        if: steps.check-branch.outputs.exists != 'true' && steps.vars.outputs.project != 'kubestellar'
        run: |
          echo "Cloning ${{ steps.vars.outputs.source_repo }} at ${{ steps.vars.outputs.source_branch }}..."
          git clone --branch "${{ steps.vars.outputs.source_branch }}" --depth 1 \
            "https://github.com/${{ steps.vars.outputs.source_repo }}.git" /tmp/source

      - name: Create version branch
        if: steps.check-branch.outputs.exists != 'true'
        run: |
          git checkout -b "${{ steps.branch.outputs.name }}"

          PROJECT="${{ steps.vars.outputs.project }}"

          # KubeStellar docs already live in this repo - just create branch, no copy needed
          if [ "$PROJECT" = "kubestellar" ]; then
            echo "KubeStellar docs live in this repo - creating version branch from current main"
            echo "No content copy needed"
            exit 0
          fi

          # For other projects, copy docs from source repo
          echo "Copying docs for project: $PROJECT"

          case "$PROJECT" in
            a2a)
              rm -rf docs/content/a2a/*
              if [ -d "/tmp/source/docs-site/docs" ]; then
                cp -r /tmp/source/docs-site/docs/* docs/content/a2a/
                echo "Copied A2A docs from docs-site/docs/"
              elif [ -d "/tmp/source/docs" ]; then
                cp -r /tmp/source/docs/* docs/content/a2a/
                echo "Copied A2A docs from docs/"
              else
                echo "Warning: No docs directory found in A2A source"
              fi
              ;;
            kubeflex)
              rm -rf docs/content/kubeflex/*
              if [ -d "/tmp/source/docs" ]; then
                cp -r /tmp/source/docs/* docs/content/kubeflex/
                echo "Copied KubeFlex docs from docs/"
              else
                echo "Warning: /tmp/source/docs not found"
              fi
              ;;
            multi-plugin)
              rm -rf docs/content/multi-plugin/*
              if [ -d "/tmp/source/docs" ]; then
                cp -r /tmp/source/docs/* docs/content/multi-plugin/
                echo "Copied Multi-Plugin docs from docs/"
              else
                echo "Warning: /tmp/source/docs not found"
              fi
              ;;
            kubectl-claude)
              rm -rf docs/content/kubectl-claude/*
              if [ -d "/tmp/source/docs" ]; then
                cp -r /tmp/source/docs/* docs/content/kubectl-claude/
                echo "Copied kubectl-claude docs from docs/"
              else
                echo "Warning: /tmp/source/docs not found"
              fi
              ;;
          esac

      - name: Commit and push branch
        if: steps.check-branch.outputs.exists != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -s -m "docs: add ${{ steps.vars.outputs.project }} ${{ steps.branch.outputs.version }} docs

          Source: ${{ steps.vars.outputs.source_repo }}@${{ steps.vars.outputs.source_branch }}

          Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
          git push origin "${{ steps.branch.outputs.name }}"
          echo "âœ… Pushed branch ${{ steps.branch.outputs.name }}"

      - name: Setup Node.js
        if: steps.vars.outputs.set_latest == 'true'
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'

      - name: Create PR to update versions.ts
        if: steps.vars.outputs.set_latest == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_SYNC_TOKEN }}
        run: |
          # Go back to main for the PR
          git checkout main
          git pull origin main

          PR_BRANCH="update-${{ steps.vars.outputs.project }}-${{ steps.branch.outputs.version }}"
          git checkout -b "$PR_BRANCH"

          # Update versions.ts using node script
          node scripts/update-version.js \
            --project "${{ steps.vars.outputs.project }}" \
            --version "${{ steps.branch.outputs.version }}" \
            --branch "${{ steps.branch.outputs.name }}" \
            --set-latest

          git add src/config/versions.ts
          git commit -s -m "chore: update ${{ steps.vars.outputs.project }} to v${{ steps.branch.outputs.version }}

          Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
          git push origin "$PR_BRANCH"

          # Create PR
          gh pr create \
            --title "ðŸ“– Update ${{ steps.vars.outputs.project }} docs to v${{ steps.branch.outputs.version }}" \
            --body "## Summary
          Automated update for ${{ steps.vars.outputs.project }} release v${{ steps.branch.outputs.version }}.

          - Created branch: \`${{ steps.branch.outputs.name }}\`
          - Source: ${{ steps.vars.outputs.source_repo }}@${{ steps.vars.outputs.source_branch }}

          ## Checklist
          - [ ] Verify branch deploys correctly on Netlify
          - [ ] Verify version appears in dropdown

          ðŸ¤– Generated automatically on release"
          echo "âœ… Created PR to update versions.ts"
