name: KubeFlex Compatibility Matrix

on:
  schedule:
    - cron: '0 4 * * *' # Runs daily at 4 AM UTC
  workflow_dispatch:
    inputs:
      kubestellar_ref:
        description: 'KubeStellar git ref (branch, tag, or commit)'
        required: true
        default: 'main'

permissions:
  contents: read

jobs:
  setup-and-deploy:
    name: Setup Environment and Deploy KubeStellar
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: ${{ github.event.inputs.kubestellar_ref || 'main' }}

      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5
        with:
          go-version: '1.24'
          cache: true

      - name: Install kubectl
        uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede

      - uses: ko-build/setup-ko@d006021bd0c28d1ce33a07e7943d48b079944c8d

      - name: Install common dependencies
        run: |
          bash <(curl -L https://raw.githubusercontent.com/open-cluster-management-io/clusteradm/main/install.sh)
          go install github.com/onsi/ginkgo/v2/ginkgo

      - name: Setup KubeStellar
        run: |
          cd test/e2e/
          ./common/setup-kubestellar.sh

      - name: Upload kubeconfig
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: kubeconfig
          path: ~/.kube/config

  generate-matrix:
    name: Generate KubeFlex version matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Generate kflex version matrix
        id: generate
        run: |
          MIN_VERSION="v0.8.0"
          VERSIONS=$(curl -s "https://api.github.com/repos/kubestellar/kubeflex/releases" | jq -r '.[].tag_name' | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V)

          MATRIX_VERSIONS='[]'
          while read -r v; do
            if [[ "$(printf '%s\n%s' "$v" "$MIN_VERSION" | sort -V | head -n1)" == "$MIN_VERSION" ]]; then
              MATRIX_VERSIONS=$(echo $MATRIX_VERSIONS | jq --arg v "$v" '. + [$v]')
            fi
          done <<< "$VERSIONS"

          echo "matrix=$(echo $MATRIX_VERSIONS | jq -c .)" >> $GITHUB_OUTPUT

  test-kubeflex-version:
    name: Test with kflex ${{ matrix.kflex_version }}
    needs: [setup-and-deploy, generate-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        kflex_version: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          ref: ${{ github.event.inputs.kubestellar_ref || 'main' }}

      - name: Download kubeconfig
        uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a
        with:
          name: kubeconfig
          path: ~/.kube

      - name: Download and install kflex
        run: |
          KFLEX_VERSION=${{ matrix.kflex_version }}
          wget https://github.com/kubestellar/kubeflex/releases/download/${KFLEX_VERSION}/kubeflex_${KFLEX_VERSION#v}_linux_amd64.tar.gz
          tar -xvf kubeflex_${KFLEX_VERSION#v}_linux_amd64.tar.gz bin/kflex
          sudo mv bin/kflex /usr/local/bin

      - name: Run e2e tests
        env:
          KFLEX_DISABLE_CHATTY: "true"
        run: |
          cd test/e2e/ginkgo
          ginkgo -vv --trace --no-color --fail-fast -- -kubestellar-setup-flags="--kubestellar-controller-manager-verbosity 5 --transport-controller-verbosity 5" --skip-setup

      - name: Show kubeconfig contexts
        if: always()
        run: kubectl config get-contexts

      - name: Show pods in hosting cluster
        if: always()
        run: |
          echo "--- Pods in hosting cluster ---"
          kubectl --context kind-kubeflex get pods -A
          echo "--- Describe failing pods ---"
          kubectl --context kind-kubeflex get pods -A | grep -vw Running | grep -vw Completed | grep -v NAME | while read ns name rest; do
            echo "--- Describing pod $ns/$name ---"
            kubectl --context kind-kubeflex describe pod -n $ns $name
            echo "--- Logs for pod $ns/$name ---"
            kubectl --context kind-kubeflex logs -n $ns $name --all-containers=true || true
            echo "--- Previous logs for pod $ns/$name ---"
            kubectl --context kind-kubeflex logs -p -n $ns $name --all-containers=true || true
          done

      - name: Show all resources in hosting cluster
        if: always()
        run: |
          echo "--- All resources in hosting cluster ---"
          kubectl --context kind-kubeflex get all -A

      - name: Show all resources in its1
        if: always()
        run: |
          echo "--- All resources in its1 cluster ---"
          kubectl --context its1 get all -A