name: Preview Links - Comment

on:
  workflow_run:
    workflows: ["Preview Links - Collect"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  post-preview-links:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Download PR info
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          name: pr-info
          path: pr-info
          run_id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR number
        id: pr
        run: |
          PR_NUMBER=$(cat pr-info/pr_number)
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR number: $PR_NUMBER"

      - name: Wait for Netlify deploy
        uses: jakepartusch/wait-for-netlify-action@f1e137043864b9ab9034ae3a5adc1c108e3f1a48  # v1.4
        id: netlify
        with:
          site_name: kubestellar-docs
          max_timeout: 300
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files and post comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER, 10);
            const previewUrl = `https://deploy-preview-${prNumber}--kubestellar-docs.netlify.app`;

            // Get changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              per_page: 100
            });

            // Filter for markdown files in docs/content and convert to URLs
            const docFiles = files
              .filter(f => f.filename.startsWith('docs/content/') && f.filename.endsWith('.md'))
              .map(f => {
                // Convert: docs/content/path/to/file.md -> /docs/path/to/file/
                const urlPath = f.filename
                  .replace('docs/content/', '/docs/')
                  .replace('.md', '/');
                return {
                  file: f.filename,
                  url: `${previewUrl}${urlPath}`,
                  status: f.status
                };
              });

            if (docFiles.length === 0) {
              console.log('No doc files changed');
              return;
            }

            // Build comment body
            const statusEmoji = {
              added: 'âœ¨',
              modified: 'ðŸ“',
              removed: 'ðŸ—‘ï¸',
              renamed: 'ðŸ“›'
            };

            let body = `## ðŸ“– Preview Links\n\n`;
            body += `The following documentation pages were changed in this PR:\n\n`;
            body += `| Status | Page | Preview Link |\n`;
            body += `|--------|------|-------------|\n`;

            for (const doc of docFiles) {
              const emoji = statusEmoji[doc.status] || 'ðŸ“„';
              const pageName = doc.file.split('/').pop().replace('.md', '');
              if (doc.status === 'removed') {
                body += `| ${emoji} ${doc.status} | \`${pageName}\` | *(deleted)* |\n`;
              } else {
                body += `| ${emoji} ${doc.status} | \`${pageName}\` | [View preview](${doc.url}) |\n`;
              }
            }

            body += `\n---\n`;
            body += `ðŸ”— [Full preview site](${previewUrl})\n`;

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## ðŸ“– Preview Links')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log('Created new comment');
            }
