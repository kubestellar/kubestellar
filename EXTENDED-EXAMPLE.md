# KCP-Edge User Guide:

## Required Packages:
   - docker
   - kind
   - kubectl (version range expected: 1.23-1.25)


## Setup Instructions

Table of contents:

- [1. Create your own edge infrastructure (edge clusters)](#1-create-your-own-edge-infrastructure-edge-clusters)
- [2. Install KCP](#2-install-kcp)
- [3. Deploy the kcp-edge platform](#3-deploy-the-kcp-edge-platform)
- [4. Connect your edge cluster to the kcp-edge platform](#4-connect-your-edge-cluster-to-the-kcp-edge-platform)
  - [a. Create an inventory management workspace (imw)](#a-create-an-inventory-management-workspace-imw)
  - [b. Create a syncTarget and location objects to represent your edge cluster (florin)](#b-create-a-synctarget-and-location-objects-to-represent-your-edge-cluster-florin)
  - [c. Connect florin edge cluster with its mailbox workspace](#c-connect-florin-edge-cluster-with-its-mailbox-workspace)
  - [d. Deploy the edge syncer to florin edge cluster](#d-deploy-the-edge-syncer-to-florin-edge-cluster)
- [5. Deploy a workload to the edge cluster](#5-deploy-a-workload-to-the-edge-cluster)
  - [a. Create a workload management workspace (wmw)](#a-create-a-workload-management-workspace-wmw)
  - [b. Deploy your workload in wmw-1](#b-deploy-your-workload-in-wmw-1)
  - [c. Create the EdgePlacement object for your workload](#c-create-the-edgeplacement-object-for-your-workload)
  - [d. Check that the workloads objects are copied to mailbox workspace](#d-check-that-the-workloads-objects-are-copied-to-mailbox-workspace)
  - [e. Check that the workloads are running in the edge clusters](#e-check-that-the-workloads-are-running-in-the-edge-clusters)
- [6. Cleanup the environment](#6-Cleanup-the-environment)


This guide is intended to explain how KCP-Edge works with a detailed example.

### 1. Create your own edge infrastructure (edge clusters)

Bring your own k8s edge clusters. In this example, we deploy only a single cluster using [kind](https://kind.sigs.k8s.io/). Our edge cluster is named “florin”:

```shell
kind create cluster --name florin
```  

### 2. Install KCP

Since `KCP-Edge` leverages [`kcp`](kcp.io) logical workspaces capability, we first need to install `kcp` v0.11.0 binaries. To install kcp follow the instructions available [on the kcp website](https://docs.kcp.io/kcp/main/#download-kcp). You can also use the script below:

```shell
bash <(curl -s https://raw.githubusercontent.com/kcp-dev/edge-mc/main/hack/install-kcp-with-plugins.sh) --version v0.11.0 --folder $(pwd)/kcp --create-folder
export PATH="$PATH:$(pwd)/kcp/bin"
```

Start **kcp** with the following command:

```shell
kcp start >& kcp_log.txt &
export KUBECONFIG="$(pwd)/.kcp/admin.kubeconfig"
```

It should be noted that, when **kcp** is running with the command above, it listens to all of the host's non-loopback addresses and picks one to put in the generated `admin.kubeconfig` file. While this works fine in most cases, such as when using a kind cluster locally (see later), sometimes it may be necessary to specify a public/external ip address that can be reached by remote clusters. For this purpose, the following commands should be used:


```shell
kcp start --bind-address <ip_address> >& kcp_log.txt &
export KUBECONFIG="$(pwd)/.kcp/admin.kubeconfig"
```

In this case, the specified `<ip_address>` will appear in the generated `admin.kubeconfig` generated by the `kcp`.

After few seconds, check that `kcp` is running using the command:

```console
$ kubectl version --short

Client Version: v1.25.3
Kustomize Version: v4.5.7
Server Version: v1.24.3+kcp-v0.11.0
```

Additionally, one can check the available virtual workspaces using the command:

```console
$ kubectl ws tree

.
└── root
    └── compute
```

### 3. Deploy the kcp-edge platform
         
  Download the kcp **KCP-Edge** binaries and scripts into a `kcp-edge` subfolder in your current working directory using the following command:

  ```shell
  bash <(curl -s https://raw.githubusercontent.com/kcp-dev/edge-mc/main/hack/install-kcp-edge.sh) --version v0.1.0 --folder $(pwd)/kcp-edge --create-folder
  export PATH="$PATH:$(pwd)/kcp-edge/bin"
  ```

  Start **KCP-Edge** with the following command:

  ```shell
  kcp-edge start --user kit
  ```

  The following components are created:

  - 1 kcp workspace: edge service provider workspace (`espw`)

  ```console
  $ kubectl ws tree
  .
  └── root
      ├── compute
      └── espw
  ```

  - 3 kcp-edge controllers: [edge-scheduler](https://docs.kcp-edge.io/docs/coding-milestones/poc2023q1/edge-scheduler/), [mailbox-controller](https://docs.kcp-edge.io/docs/coding-milestones/poc2023q1/mailbox-controller/) and [placement-translator](https://docs.kcp-edge.io/docs/coding-milestones/poc2023q1/placement-translator/)

  ```shell
  $ ps aux | grep -e mailbox-controller -e placement-translator -e scheduler
  user    11344   0.1  0.1 34906508  28044 s001  S     8:36PM   0:00.43 placement-translator --allclusters-context system:admin -v=2
  user    11333   0.1  0.1 34885544  19536 s001  S     8:36PM   0:00.38 scheduler -v 2 --root-user kcp-admin --root-cluster root --sysadm-context system:admin --sysadm-user shard-admin
  user    11323   0.0  0.1 34892244  20780 s001  S     8:36PM   0:00.13 mailbox-controller --inventory-context=root --mbws-context=base -v=2
  ```

### 4. Connect your edge cluster to the kcp-edge platform:

#### a. Create an inventory management workspace (`imw`):

```console
$ kubectl ws root
$ kubectl ws create imw-1 --enter

Workspace "imw-1" (type root:organization) created. Waiting for it to be ready...
Workspace "imw-1" (type root:organization) is ready to use.
Current workspace is "root:imw-1" (type root:organization).
```
  
#### b. Create a syncTarget and location objects to represent your edge cluster (florin):

```console
$ kcp-edge --create_inv_item florin  env=prod

synctarget.workload.kcp.io/florin created
location.scheduling.kcp.io/florin created
synctarget.workload.kcp.io/florin labeled
location.scheduling.kcp.io/florin labeled
```

The following commands list the objects that were created:

```console
$ kubectl get locations,synctargets
NAME                                RESOURCE      AVAILABLE   INSTANCES   LABELS   AGE
location.scheduling.kcp.io/florin   synctargets   0           1                    57s

NAME                                AGE
synctarget.workload.kcp.io/florin   58s
```


The [mailbox-controller](https://docs.kcp-edge.io/docs/coding-milestones/poc2023q1/mailbox-controller/) creates a mailbox workspace for the newly created SyncTarget (`florin`):

```console
$ kubectl ws root
Current workspace is "root".

$ kubectl ws tree
.
└── root
    ├── compute
    ├── espw
    │   └── 19igldm1mmolruzr-mb-6b0309f0-84f3-4926-9344-81df2f989f69
    └── imw-1
```

#### c. Connect florin edge cluster with its mailbox workspace:

```shell
$ kubectl ws root:espw
Current workspace is "root:espw".

$ kcp-edge --syncer florin

Current workspace is "root:espw:19igldm1mmolruzr-mb-6b0309f0-84f3-4926-9344-81df2f989f69" (type root:universal).

Creating service account "kcp-edge-syncer-florin-5c4r0a44"
Creating cluster role "kcp-edge-syncer-florin-5c4r0a44" to give service account "kcp-edge-syncer-florin-5c4r0a44"

1. write and sync access to the synctarget "kcp-edge-syncer-florin-5c4r0a44"
2. write access to apiresourceimports.

Creating or updating cluster role binding "kcp-edge-syncer-florin-5c4r0a44" to bind service account "kcp-edge-syncer-florin-5c4r0a44" to cluster role "kcp-edge-syncer-florin-5c4r0a44".

Wrote physical cluster manifest to florin-syncer.yaml for namespace "kcp-edge-syncer-florin-5c4r0a44". Use

  KUBECONFIG=<edge-cluster-config> kubectl apply -f "florin-syncer.yaml"

to apply it. Use

  KUBECONFIG=<edge-cluster-config> kubectl get deployment -n "kcp-edge-syncer-florin-5c4r0a44" kcp-edge-syncer-florin-5c4r0a44

to verify the syncer pod is running.
```

An edge syncer manifest yaml file is created in your current director: `florin-syncer.yaml`. The default for the output file is the name of the SyncTarget object with “-syncer.yaml” appended. On the first usage above `mailbox-prep.sh` script will git clone the repo that has the source for edge syncer plugin and build it locally.


#### d. Deploy the edge syncer to florin edge cluster:

For example: switch to the context of the florin kind cluster

```console
$ KUBECONFIG=$florin_kubeconfig kubectl apply -f florin-syncer.yaml

namespace/kcp-edge-syncer-florin-5c4r0a44 created
serviceaccount/kcp-edge-syncer-florin-5c4r0a44 created
secret/kcp-edge-syncer-florin-5c4r0a44-token created
clusterrole.rbac.authorization.k8s.io/kcp-edge-syncer-florin-5c4r0a44 created
clusterrolebinding.rbac.authorization.k8s.io/kcp-edge-syncer-florin-5c4r0a44 created
role.rbac.authorization.k8s.io/kcp-edge-dns-florin-5c4r0a44 created
rolebinding.rbac.authorization.k8s.io/kcp-edge-dns-florin-5c4r0a44 created
secret/kcp-edge-syncer-florin-5c4r0a44 created
deployment.apps/kcp-edge-syncer-florin-5c4r0a44 created
```

Check that the edge syncer pod is running:

```console
$ KUBECONFIG=$florin_kubeconfig kubectl get pods -A
NAMESPACE                         NAME                                              READY   STATUS    RESTARTS   AGE
kcp-edge-syncer-florin-5c4r0a44   kcp-edge-syncer-florin-5c4r0a44-bb8c8db4b-ng8sz   1/1     Running   0          30s
kube-system                       coredns-565d847f94-kr2pw                          1/1     Running   0          85s
kube-system                       coredns-565d847f94-rj4s8                          1/1     Running   0          85s
kube-system                       etcd-florin-control-plane                         1/1     Running   0          99s
kube-system                       kindnet-l26qt                                     1/1     Running   0          85s
kube-system                       kube-apiserver-florin-control-plane               1/1     Running   0          100s
kube-system                       kube-controller-manager-florin-control-plane      1/1     Running   0          100s
kube-system                       kube-proxy-qzhx6                                  1/1     Running   0          85s
kube-system                       kube-scheduler-florin-control-plane               1/1     Running   0          99s
local-path-storage                local-path-provisioner-684f458cdd-75wv8           1/1     Running   0          85s
``` 


### 5. Deploy a workload to the edge cluster:

#### a. Create a workload management workspace (`wmw`):

```console
$ kubectl ws root
$ kubectl ws create my-org --enter

$ kcp-edge --create_wmw wmw-1

Current workspace is "root".
Current workspace is "root:my-org".
Workspace "wmw-1" (type root:universal) created. Waiting for it to be ready...
Workspace "wmw-1" (type root:universal) is ready to use.
Current workspace is "root:my-org:wmw-1" (type root:universal).
apibinding.apis.kcp.io/bind-espw created
apibinding.apis.kcp.io/bind-kube created
```

#### b. Deploy your workload in `wmw-1`:

For example:

```console
kubectl apply -f - <<EOF
apiVersion: v1
kind: Namespace
metadata:
  name: commonstuff
  labels: {common: "si"}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  namespace: commonstuff
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
EOF
```

Check that your workload was deployed successfully: 

```console
$ kubectl -n commonstuff get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   0/3     0            0           13s
```

#### c. Create the `EdgePlacement` object for your workload:

In the `wmw-1` workspace create the following `EdgePlacement` object: 

```console
$ kubectl ws root:my-org:wmw-1

kubectl apply -f - <<EOF
apiVersion: edge.kcp.io/v1alpha1
kind: EdgePlacement
metadata:
  name: edge-placement-c
spec:
  locationSelectors:
  - matchLabels: {"env":"prod"}
  namespaceSelector:
    matchLabels: {"common":"si"}
  nonNamespacedObjects:
  - apiGroup: apis.kcp.io
    resources: [ "apibindings" ]
    resourceNames: [ "bind-kube" ]
  upsync:
  - apiGroup: "group1.test"
    resources: ["sprockets", "flanges"]
    namespaces: ["orbital"]
    names: ["george", "cosmo"]
  - apiGroup: "group2.test"
    resources: ["cogs"]
    names: ["william"]
EOF
```
Its “where predicate” (the locationSelectors array) has one label selector that matches the Location object created earlier, thus directing the workload to your edge cluster.

In response to the created `EdgePlacement`, the edge [scheduler](https://docs.kcp-edge.io/docs/coding-milestones/poc2023q1/edge-scheduler/) will create a corresponding `SinglePlacementSlice` object:

```console
$ kubectl get SinglePlacementSlice -o yaml edge-placement-c
apiVersion: edge.kcp.io/v1alpha1
destinations:
- cluster: 19igldm1mmolruzr
  locationName: florin
  syncTargetName: florin
  syncTargetUID: 6b0309f0-84f3-4926-9344-81df2f989f69
kind: SinglePlacementSlice
metadata:
  annotations:
    kcp.io/cluster: 2aqjl32hksrd4nok
  creationTimestamp: "2023-05-02T04:00:45Z"
  generation: 1
  name: edge-placement-c
  ownerReferences:
  - apiVersion: edge.kcp.io/v1alpha1
    kind: EdgePlacement
    name: edge-placement-c
    uid: 3f20a0a4-ed9a-4114-960e-0aa3d42802e3
  resourceVersion: "1161"
  uid: 32882961-fb77-4a95-be92-1ad6b088d082
```

#### d. Check that the workloads objects are copied to mailbox workspace:

In response to the created EdgePlacement and SinglePlacementSlice objects, the [placement translator](https://docs.kcp-edge.io/docs/coding-milestones/poc2023q1/placement-translator/) will copy the workload prescriptions into the mailbox workspaces and create `SyncerConfig` objects there.

Use the following commands to obtain the name of the mailbox workspace (`mbws`) associated with the SyncTarget created earlier 

```console
$ kubectl ws root:espw
$ stname=florin
$ mbws=$(kubectl get Workspace -o json | jq -r ".items | .[] | .metadata | select(.annotations [\"edge.kcp.io/sync-target-name\"] == \"$stname\") | .name")
```

Then check the objects created in the mailbox workspace:

```console
$ kubectl ws root:espw:$mbws
Current workspace is "root:espw:$mbws

$ kubectl get ns
NAME          STATUS   AGE
commonstuff   Active   4m
default       Active   114m

$ kubectl -n commonstuff get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   0/3     0            0           4m7s

$ kubectl get syncerConfig
NAME      AGE
the-one   4m26s
```

```console
$ kubectl get syncerConfig the-one -o yaml
apiVersion: edge.kcp.io/v1alpha1
kind: SyncerConfig
metadata:
  annotations:
    kcp.io/cluster: 1jaofi54318wchgc
  creationTimestamp: "2023-05-02T04:00:45Z"
  generation: 2
  name: the-one
  resourceVersion: "1163"
  uid: 7f618cf8-7ead-49f3-b410-ed9d52f50fe1
spec:
  namespaceScope:
    namespaces:
    - commonstuff
    resources:
    - apiVersion: v1
      group: ""
      resource: resourcequotas
    - apiVersion: v1
      group: apps
      resource: deployments
    - apiVersion: v1
      group: ""
      resource: limitranges
    - apiVersion: v1
      group: ""
      resource: configmaps
    - apiVersion: v1
      group: ""
      resource: services
    - apiVersion: v1
      group: networking.k8s.io
      resource: ingresses
    - apiVersion: v1
      group: coordination.k8s.io
      resource: leases
    - apiVersion: v1
      group: rbac.authorization.k8s.io
      resource: roles
    - apiVersion: v1
      group: ""
      resource: secrets
    - apiVersion: v1
      group: rbac.authorization.k8s.io
      resource: rolebindings
    - apiVersion: v1
      group: ""
      resource: pods
    - apiVersion: v1
      group: ""
      resource: serviceaccounts
  upsync:
  - apiGroup: group1.test
    names:
    - george
    - cosmo
    namespaces:
    - orbital
    resources:
    - sprockets
    - flanges
  - apiGroup: group2.test
    names:
    - william
    resources:
    - cogs
status: {}
```

#### e. Check that the workloads are running in the edge clusters:

```console
$ KUBECONFIG=$florin_kubeconfig kubectl get ns

NAME                              STATUS   AGE
commonstuff                       Active   8m7s
default                           Active   86m
kcp-edge-syncer-florin-5c4r0a44   Active   85m
kube-node-lease                   Active   86m
kube-public                       Active   86m
kube-system                       Active   86m
local-path-storage                Active   86m

$ KUBECONFIG=$florin_kubeconfig kubectl -n commonstuff get deployment
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           8m37s


$ KUBECONFIG=$florin_kubeconfig kubectl -n commonstuff get pods
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-7fb96c846b-2hkwt   1/1     Running   0          8m57s
nginx-deployment-7fb96c846b-9lxtc   1/1     Running   0          8m57s
nginx-deployment-7fb96c846b-k8pp7   1/1     Running   0          8m57s
```

### 6. Cleanup the environment:

To uninstall kcp-edge run the following command:

```bash
kcp-edge stop
```

To uninstall kcp, kcp-edge and delete all the generated files (e.g., edge syncer manifests and logs files) run the following command:

```shell
kcp-edge cleanup
```